#!/usr/bin/env bash

source ./scripts/_init

set -x

yarn run prepublishOnly

# setup workspace
o="$BASE_DIR"
rm -rf "${o}"
mkdir -p "${o}/node_modules"
mkdir -p "${o}/bin"
cp "$ROOT_DIR/README.md" "${o}"
cp "$ROOT_DIR/LICENSE" "${o}"
cp "$ROOT_DIR/package.json" "${o}"
cp "$ROOT_DIR/yarn.lock" "${o}"
cp "$ROOT_DIR/bin/run" "${o}/bin/heroku.js"
cp "$ROOT_DIR/.oclif.manifest.json" "${o}"
cp -rv "$ROOT_DIR/lib" "${o}/lib"

node -e "
const fs = require('fs-extra')
const pjson = fs.readJSONSync('$o/package.json')
pjson.version = '$VERSION'
pjson.oclif.channel = '$CHANNEL'
fs.outputJSONSync('$o/package.json', pjson, {spaces: 2})
"

(
  cd "${o}" || exit 1
  # install packages
  yarn install --no-progress --production --non-interactive
)
